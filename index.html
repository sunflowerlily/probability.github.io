import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

def simulate_law_of_large_numbers(distribution='bernoulli', p=0.5, mean=0, std=1, max_n=10000):
    """
    模拟大数定律过程
    
    参数:
    distribution: 分布类型，可选'bernoulli'（伯努利）、'uniform'（均匀）、'normal'（正态）
    p: 伯努利分布的成功概率
    mean: 正态分布的均值
    std: 正态分布的标准差
    max_n: 最大样本数量
    """
    # 根据分布类型生成数据
    if distribution == 'bernoulli':
        # 伯努利分布，期望值为p
        data = np.random.binomial(1, p, max_n)
        expected_value = p
        title = f'伯努利分布大数定律模拟 (p={p})'
        ylabel = '样本均值'
    elif distribution == 'uniform':
        # 均匀分布(0,1)，期望值为0.5
        data = np.random.uniform(0, 1, max_n)
        expected_value = 0.5
        title = '均匀分布(0,1)大数定律模拟'
        ylabel = '样本均值'
    elif distribution == 'normal':
        # 正态分布，期望值为mean
        data = np.random.normal(mean, std, max_n)
        expected_value = mean
        title = f'正态分布大数定律模拟 (μ={mean}, σ={std})'
        ylabel = '样本均值'
    else:
        raise ValueError("分布类型必须是'bernoulli'、'uniform'或'normal'")
    
    # 计算累积平均值
    cumulative_mean = np.cumsum(data) / np.arange(1, max_n + 1)
    
    # 创建图形
    fig, ax = plt.subplots(figsize=(12, 6))
    ax.set_xlim(0, max_n)
    ax.set_ylim(expected_value - 0.5, expected_value + 0.5)
    ax.set_xlabel('样本数量 (n)', fontsize=14)
    ax.set_ylabel(ylabel, fontsize=14)
    ax.set_title(title, fontsize=16, pad=20)
    
    # 绘制期望值线
    ax.axhline(y=expected_value, color='r', linestyle='--', linewidth=2, label=f'期望值 = {expected_value}')
    
    # 初始化累积平均曲线
    line, = ax.plot([], [], 'b-', linewidth=2, label='样本均值')
    
    # 初始化当前点
    point, = ax.plot([], [], 'ro', markersize=6)
    
    # 添加图例
    ax.legend(fontsize=12)
    
    # 添加网格线
    ax.grid(True, alpha=0.3)
    
    # 设置动画更新函数
    def update(frame):
        # 更新曲线数据
        line.set_data(range(1, frame + 1), cumulative_mean[:frame])
        # 更新当前点
        point.set_data(frame, cumulative_mean[frame - 1])
        # 更新标题，显示当前样本数量和均值
        ax.set_title(f'{title}\n当前样本数: {frame}, 样本均值: {cumulative_mean[frame - 1]:.6f}', 
                    fontsize=16, pad=20)
        return line, point
    
    # 创建动画
    ani = animation.FuncAnimation(fig, update, frames=range(1, max_n + 1, 10), 
                                 interval=20, blit=True, repeat=False)
    
    # 保存动画为GIF
    gif_path = f'law_of_large_numbers_{distribution}.gif'
    ani.save(gif_path, writer='pillow', fps=60, dpi=100)
    print(f"大数定律模拟动画已保存至: {gif_path}")
    
    # 绘制静态图，展示完整过程
    fig, ax = plt.subplots(figsize=(12, 6))
    ax.plot(range(1, max_n + 1), cumulative_mean, 'b-', linewidth=2, label='样本均值')
    ax.axhline(y=expected_value, color='r', linestyle='--', linewidth=2, label=f'期望值 = {expected_value}')
    ax.set_xlim(0, max_n)
    ax.set_ylim(expected_value - 0.5, expected_value + 0.5)
    ax.set_xlabel('样本数量 (n)', fontsize=14)
    ax.set_ylabel(ylabel, fontsize=14)
    ax.set_title(title, fontsize=16, pad=20)
    ax.legend(fontsize=12)
    ax.grid(True, alpha=0.3)
    
    # 保存静态图
    static_path = f'law_of_large_numbers_{distribution}.png'
    plt.savefig(static_path, dpi=300, bbox_inches='tight')
    print(f"大数定律模拟静态图已保存至: {static_path}")
    
    # 显示静态图
    plt.show()

# 运行模拟
simulate_law_of_large_numbers(distribution='bernoulli', p=0.5, max_n=10000)
simulate_law_of_large_numbers(distribution='uniform', max_n=10000)
simulate_law_of_large_numbers(distribution='normal', mean=0, std=1, max_n=10000)
